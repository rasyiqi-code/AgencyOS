generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model Project {
  id                 String     @id @default(cuid())
  userId             String
  title              String
  description        String?
  status             String     @default("queue")
  repoUrl            String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  repoName           String?
  repoOwner          String?
  deployUrl          String?
  developerId        String?
  spec               String?
  estimateId         String?    @unique
  files              Json?
  serviceId          String?
  clientName         String?
  invoiceId          String?
  previewUrl         String?
  subscriptionEndsAt DateTime?
  subscriptionStatus String?
  paymentStatus      String     @default("UNPAID") // UNPAID, PARTIAL, PAID
  paidAmount         Float      @default(0)
  totalAmount        Float      @default(0)
  bounty             Float?     // Budget for Squad (Net)
  briefs             Brief[]
  dailyLogs          DailyLog[]
  feedback           Feedback[]
  applications       MissionApplication[]
  orders             Order[]
  estimate           Estimate?  @relation(fields: [estimateId], references: [id])
  service            Service?   @relation(fields: [serviceId], references: [id])
}

model Order {
  id              String   @id @default(cuid())
  amount          Float
  status          String   @default("pending")
  snapToken       String?
  transactionId   String?  @unique
  paymentType     String?
  type            String   @default("FULL") // FULL, DP, REPAYMENT
  currency        String   @default("USD")
  exchangeRate    Float    @default(1)
  userId          String
  projectId       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  paymentMetadata Json?
  proofUrl        String?
  project         Project? @relation(fields: [projectId], references: [id])
}

model Brief {
  id          String   @id @default(cuid())
  projectId   String
  content     String
  createdAt   DateTime @default(now())
  attachments Json?
  project     Project  @relation(fields: [projectId], references: [id])
}

model Feedback {
  id        String            @id @default(cuid())
  projectId String
  content   String
  type      String            @default("bug")
  status    String            @default("open")
  createdAt DateTime          @default(now())
  imageUrl  String?
  metadata  Json?
  project   Project           @relation(fields: [projectId], references: [id])
  comments  FeedbackComment[]
}

model FeedbackComment {
  id         String   @id @default(cuid())
  feedbackId String
  content    String
  role       String   @default("client")
  createdAt  DateTime @default(now())
  imageUrl   String?
  feedback   Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
}

model Ticket {
  id        String           @id @default(cuid())
  userId    String?
  email     String?
  name      String?
  status    String           @default("open")
  type      String           @default("ticket")
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  messages  SupportMessage[]
}

model SupportMessage {
  id          String   @id @default(cuid())
  ticketId    String
  sender      String
  content     String
  createdAt   DateTime @default(now())
  attachments Json?
  ticket      Ticket   @relation(fields: [ticketId], references: [id])
}

model Estimate {
  id          String   @id @default(cuid())
  prompt      String
  title       String
  summary     String
  screens     Json
  apis        Json
  totalHours  Int
  totalCost   Float
  complexity  String
  createdAt   DateTime @default(now())
  status      String   @default("draft")
  proofUrl    String?
  serviceId   String?
  creatorName String?
  userId      String?
  service     Service? @relation(fields: [serviceId], references: [id])
  project     Project?
}

model SystemKey {
  id        String   @id @default(cuid())
  key       String   @unique
  provider  String   @default("google")
  label     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  modelId   String?
}

model SystemSetting {
  key         String   @id
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}

model Service {
  id             String     @id @default(cuid())
  title          String
  description    String
  price          Float
  interval       String     @default("one_time")
  features       Json
  image          String?
  isActive       Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  creemProductId String?
  currency       String     @default("USD")
  description_id String?
  features_id    Json?
  title_id       String?
  estimates      Estimate[]
  projects       Project[]
}

model DailyLog {
  id        String   @id @default(cuid())
  projectId String
  content   String
  mood      String   @default("on_track")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  images    String[] @default([])
  project   Project  @relation(fields: [projectId], references: [id])
}

model SystemIntegration {
  id           String    @id @default(cuid())
  provider     String    @unique
  accessToken  String
  refreshToken String?
  expiresAt    DateTime?
  accountName  String?
  accountId    String?
  isActive     Boolean   @default(true)
  metadata     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  content   String
  type      String   @default("info")
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Coupon {
  id            String    @id @default(cuid())
  code          String    @unique
  discountType  String    @default("percentage")
  discountValue Float
  maxUses       Int?
  usedCount     Int       @default(0)
  expiresAt     DateTime?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model MarketingBonus {
  id          String   @id @default(cuid())
  title       String
  description String?
  value       String?
  icon        String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model MarketingSubscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
}

model UserPermission {
  id        String   @id @default(cuid())
  userId    String
  email     String
  key       String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, key])
}

model Changelog {
  id          String   @id @default(cuid())
  title       String
  content     String
  version     String?
  status      String   @default("draft")
  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  authorName  String?
}

model Testimonial {
  id        String   @id @default(cuid())
  name      String
  role      String
  content   String
  avatar    String?
  rating    Int      @default(5)
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PageSeo {
  id          String   @id @default(cuid())
  path        String   @unique
  title       String?
  title_id    String?
  description String?
  description_id String?
  ogImage     String?
  keywords    String?
  keywords_id String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SquadProfile {
  id           String               @id @default(cuid())
  userId       String               @unique // Link to Auth User
  name         String
  email        String
  role         String               @default("engineer") // Engineer, Designer, PM
  skills       String[]             // e.g. ["React", "Node.js", "Solidity"]
  yearsOfExp   Int
  bio          String?
  linkedin     String?
  github       String?
  portfolio    String?
  avatar       String?
  specialty    String?
  status       String               @default("pending") // pending, vetted, rejected
  availability String               @default("available") // available, busy
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  applications  MissionApplication[]
}

model MissionApplication {
  id             String       @id @default(cuid())
  missionId      String
  squadId        String
  status         String       @default("pending") // pending, interviewing, accepted, rejected

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  mission        Project      @relation(fields: [missionId], references: [id])
  squad          SquadProfile @relation(fields: [squadId], references: [id])

  @@unique([missionId, squadId]) // Prevent double applying
}




model AffiliateProfile {
  id              String          @id @default(cuid())
  userId          String          @unique
  name            String
  email           String          @unique
  referralCode    String          @unique
  status          String          @default("pending") // pending, active, suspended
  commissionRate  Float           @default(10) // Percentage
  totalEarnings   Float           @default(0)
  paidEarnings    Float           @default(0)
  bankInfo        Json?           // Bank Name, Account Number, etc.
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  referrals       ReferralUsage[]
  commissions     CommissionLog[]
  payoutRequests  PayoutRequest[]
}

model PayoutRequest {
  id              String          @id @default(cuid())
  affiliateId     String
  amount          Float
  status          String          @default("pending") // pending, approved, rejected
  bankInfo        Json?           // Snapshot info bank saat request
  notes           String?         // Catatan dari admin
  processedAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  affiliate       AffiliateProfile @relation(fields: [affiliateId], references: [id])
}

model ReferralUsage {
  id              String          @id @default(cuid())
  affiliateId     String
  referredUserId  String?         // The user who used the code (can be null if just a click)
  visitorId       String?         // Fingerprint/Cookie ID for non-logged in users
  source          String?         // e.g., "twitter", "facebook" (from query param)
  converted       Boolean         @default(false)
  convertedAt     DateTime?
  metadata        Json?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  affiliate       AffiliateProfile @relation(fields: [affiliateId], references: [id])
}

model CommissionLog {
  id              String          @id @default(cuid())
  affiliateId     String
  amount          Float
  status          String          @default("pending") // pending, paid, rejected
  orderId         String?
  description     String?
  paidAt          DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  affiliate       AffiliateProfile @relation(fields: [affiliateId], references: [id])
}

model MarketingAsset {
  id           String   @id @default(cuid())
  type         String   // 'banner', 'copy', 'widget'
  title        String
  content      String?  // Text content or HTML/JS code
  imageUrl     String?  // R2 URL for banners
  thumbnailUrl String?  // Optional preview
  category     String?  // e.g. 'Social Media', 'Email', 'Blog'
  isActive     Boolean  @default(true)
  metadata     Json?    // Dimensions, etc.
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Product {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  price       Float     @default(0)
  type        String    @default("plugin") // plugin, template, etc.
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  licenses     License[]
  digitalOrders DigitalOrder[]

  purchaseType String    @default("one_time") // one_time, subscription
  interval     String?   // month, year (if subscription)
  image        String?
  fileUrl      String?   // Link to download the product
}

model License {
  id             String    @id @default(cuid())
  key            String    @unique
  productId      String
  product        Product   @relation(fields: [productId], references: [id])
  userId         String?   // Optional: Link to a user if purchase is tracked
  status         String    @default("active") // active, revoked, expired
  maxActivations Int       @default(1)
  activations    Int       @default(0)
  expiresAt      DateTime?
  metadata       Json?     // Stores domain, IP, machine ID of activations
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  digitalOrder   DigitalOrder?
}

model DigitalOrder {
  id            String   @id @default(cuid())
  userId        String?
  userEmail     String
  userName      String?
  
  productId     String
  product       Product  @relation(fields: [productId], references: [id])
  
  amount        Float
  status        String   @default("PENDING")
  snapToken     String?
  paymentId     String?
  paymentType   String?
  paymentMetadata Json?

  licenseId     String?  @unique
  license       License? @relation(fields: [licenseId], references: [id]) 
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
